- include_vars: ../vars/rke2-cluster-vars.yml
  tags: always


- name: "{{ namespace_name }} namespace"
  kubernetes.core.k8s:
    name: "{{ namespace_name }}"
    api_version: v1
    kind: Namespace
    state: present
  run_once: true


- name: "{{ nfs_namespace_name }} namespace"
  kubernetes.core.k8s:
    name: "{{ nfs_namespace_name }}"
    api_version: v1
    kind: Namespace
    state: present
  run_once: true


# cr√©er le robot account avec le secret


- name: "{{ monitoring_namespace_name }} namespace"
  kubernetes.core.k8s:
    name: "{{ monitoring_namespace_name }}"
    api_version: v1
    kind: Namespace
    state: present
  run_once: true
  tags: rancher-monitoring


# install nfs

- name: Add helm repo for nfs-subdir-external-provisioner
  kubernetes.core.helm_repository:
    name: nfs-subdir-external-provisioner
    repo_url: "https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/"
  run_once: true


- name: "Deploy latest version of nfs-subdir-external-provisioner chart inside {{ mariadb_namespace_name }} namespace (and create it)"
  kubernetes.core.helm:
    name: nfs-subdir-external-provisioner
    chart_ref: nfs-subdir-external-provisioner/nfs-subdir-external-provisioner
    release_namespace: "{{ nfs_namespace_name }}"
    set_values:
      - value: "nfs.server={{ nfs_server_name }}"
        value_type: string
      - value: "nfs.path={{ nfs_path }}"
        value_type: string
      - value: storageClass.defaultClass=true
        value_type: string
  run_once: true


# install mariadb helm

- name: "{{ mariadb_namespace_name }} namespace"
  kubernetes.core.k8s:
    name: "{{ mariadb_namespace_name }}"
    api_version: v1
    kind: Namespace
    state: present
  run_once: true


- name: Add helm repo for mariadb-operator
  kubernetes.core.helm_repository:
    name: mariadb-operator
    repo_url: "https://helm.mariadb.com/mariadb-operator"
  run_once: true


- name: "Deploy latest version of mariadb-operator-crds chart inside {{ mariadb_namespace_name }} namespace (and create it)"
  kubernetes.core.helm:
    name: mariadb-operator-crds
    chart_ref: mariadb-operator/mariadb-operator-crds
    release_namespace: "{{ mariadb_namespace_name }}"
  run_once: true


- name: "Deploy latest version of mariadb-operator chart inside {{ mariadb_namespace_name }} namespace (and create it)"
  kubernetes.core.helm:
    name: mariadb-operator
    chart_ref: mariadb-operator/mariadb-operator
    release_namespace: "{{ mariadb_namespace_name }}"
  run_once: true

- name: IngressClass/wordpress
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: networking.k8s.io/v1
      kind: IngressClass
      metadata:
        name: wordpress
      spec:
        controller: epfl.ch/ingress-wordpress

# install monitoring

- name: Add rancher repo
  kubernetes.core.helm_repository:
    name: rancher-charts
    repo_url: "https://charts.rancher.io"
  run_once: true


- name: "Deploy latest version of rancher-monitoring-crd chart inside {{ monitoring_namespace_name }} namespace"
  kubernetes.core.helm:
    name: rancher-monitoring-crd
    chart_ref: rancher-charts/rancher-monitoring-crd
    release_namespace: "{{ monitoring_namespace_name }}"
  run_once: true


- name: "Deploy latest version of rancher-monitoring chart inside {{ monitoring_namespace_name }} namespace"
  kubernetes.core.helm:
    name: rancher-monitoring
    chart_ref: rancher-charts/rancher-monitoring
    release_namespace: "{{ monitoring_namespace_name }}"
    values:
      global:
        cattle:
          clusterId: "{{ rancher_cluster_id }}"
          clusterName: "{{ rancher_cluster_name }}"   # not for grafana, but for prometheus metrics (https://github.com/rancher/rancher/issues/41991#issuecomment-1774844555)
  run_once: true
