- include_vars: ../vars/rke2-cluster-vars.yml
  tags: always


- name: "Create {{ namespace_name }} namespace if not exist"
  kubernetes.core.k8s:
    name: "{{ namespace_name }}"
    api_version: v1
    kind: Namespace
    state: present
  run_once: true


- name: "Create {{ nfs_namespace_name }} namespace if not exist"
  kubernetes.core.k8s:
    name: "{{ nfs_namespace_name }}"
    api_version: v1
    kind: Namespace
    state: present
  run_once: true


# cr√©er le robot account avec le secret


- name: Add helm repo for nfs-subdir-external-provisioner
  kubernetes.core.helm_repository:
    name: nfs-subdir-external-provisioner
    repo_url: "https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/"
  run_once: true


- name: "Deploy latest version of nfs-subdir-external-provisioner chart inside {{ mariadb_namespace_name }} namespace (and create it)"
  kubernetes.core.helm:
    name: nfs-subdir-external-provisioner
    chart_ref: nfs-subdir-external-provisioner/nfs-subdir-external-provisioner
    release_namespace: "{{ nfs_namespace_name }}"
    set_values:
      - value: "nfs.server={{ nfs_server_name }}"
        value_type: string
      - value: "nfs.path={{ nfs_path }}"
        value_type: string
      - value: storageClass.defaultClass=true
        value_type: string
  run_once: true


# install mariadb helm

- name: "Create {{ mariadb_namespace_name }} namespace if not exist"
  kubernetes.core.k8s:
    name: "{{ mariadb_namespace_name }}"
    api_version: v1
    kind: Namespace
    state: present
  run_once: true


- name: Add helm repo for mariad-operator
  kubernetes.core.helm_repository:
    name: mariadb-operator
    repo_url: "https://helm.mariadb.com/mariadb-operator"
  run_once: true


- name: "Deploy latest version of mariad-operator-crds chart inside {{ mariadb_namespace_name }} namespace (and create it)"
  kubernetes.core.helm:
    name: mariadb-operator-crds
    chart_ref: mariadb-operator/mariadb-operator-crds
    release_namespace: "{{ mariadb_namespace_name }}"
  run_once: true


- name: "Deploy latest version of mariad-operator chart inside {{ mariadb_namespace_name }} namespace (and create it)"
  kubernetes.core.helm:
    name: mariadb-operator
    chart_ref: mariadb-operator/mariadb-operator
    release_namespace: "{{ mariadb_namespace_name }}"
  run_once: true


# /kubernetes/wpn-ngnix.yml

- name: Create MariadDB objects
  import_tasks:
    file: wpn-mariadb.yml


# /kubernetes/wpn-mariadb.yml

- name: Create nginx objects
  include_tasks:
    file: wpn-nginx.yml
    apply:
      tags:
        - cluster.nginx
  tags:
    - cluster.nginx


# TODO cluster yaml custom configuration ( Ask to Dominique)
