- include_vars: ../vars/rancher-vars.yml
  tags: always

- name: get nodes list
  kubernetes.core.k8s_info:
    kind: Node
    namespace: "{{ wpn_namespace }}"
  register: node_list
  delegate_to: localhost

- name: debug nodes list json
  debug:
    msg: "{{ node_list.resources | map(attribute='metadata.name') | join(',') }}"
  register: server_ip_list

- name: Configure control node
  ansible.builtin.shell:
    cmd: CATTLE_AGENT_FALLBACK_PATH="/opt/rke2/bin" curl --insecure -fL https://{{ RKE_INSTALL_SERVER }}/system-agent-install.sh | sudo CATTLE_AGENT_FALLBACK_PATH="/opt/rke2/bin" sh -s - --server https://{{ RKE_INSTALL_SERVER }} --label 'cattle.io/os=linux' --token {{ rancher_token }} --ca-checksum {{ rancher_checksum }} --etcd --controlplane
  when:
    - inventory_hostname not in (node_list.resources | map(attribute='metadata.name'))
    - RKE_ROLE == "control"

- name: Configure worker node
  ansible.builtin.shell:
    cmd: CATTLE_AGENT_FALLBACK_PATH="/opt/rke2/bin" curl --insecure -fL https://{{ RKE_INSTALL_SERVER }}/system-agent-install.sh | sudo CATTLE_AGENT_FALLBACK_PATH="/opt/rke2/bin" sh -s - --server https://{{ RKE_INSTALL_SERVER }} --label 'cattle.io/os=linux' --token {{ rancher_token }} --ca-checksum {{ rancher_checksum }} --worker
  when:
    - inventory_hostname not in (node_list.resources | map(attribute='metadata.name'))
    - RKE_ROLE == "worker"

- name: Install NFS for worker nodes
  ansible.builtin.apt:
    name: nfs-server
    state:
      present
  when:
    - inventory_hostname not in (node_list.resources | map(attribute='metadata.name'))
    - RKE_ROLE == "worker"
