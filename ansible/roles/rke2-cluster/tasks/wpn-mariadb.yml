- name: Create mariadb/mariadb
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: MariaDB
      metadata:
        name: mariadb-min
        namespace: "{{ namespace_name }}"
      spec:
        storage:
          size: 2G
        rootPasswordSecretKeyRef:
          name: mariadb
          key: root-password
          generate: true
        metrics:
          enabled: true


- name: Create mariadb/databse
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: Database
      metadata:
        namespace: "{{ namespace_name }}"
        name: wordpress-test
      spec:
        # If you want the database to be created with a different name than the resource name
        # name: my-logical-database
        mariaDbRef:
          name: mariadb-min
        characterSet: utf8
        collate: utf8_general_ci


- name: Create mariadb/secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: db-password
        namespace: "{{ namespace_name }}"
      stringData:
        password: secret


- name: Create mariadb/user
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: User
      metadata:
        name: wordpress
        namespace: "{{ namespace_name }}"
      spec:
        mariaDbRef:
          name: mariadb-min
        passwordSecretKeyRef:
          name: db-password
          key: password
        host: "%"
        cleanupPolicy: Delete


- name: Create mariadb/grant
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: Grant
      metadata:
        name: wordpress
        namespace: "{{ namespace_name }}"
      spec:
        mariaDbRef:
          name: mariadb-min
        privileges:
          - "ALL PRIVILEGES"
        database: "wordpress-test"
        table: "*"
        username: wordpress
        grantOption: false
        host: "%"
