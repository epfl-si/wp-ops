- include_vars: ../vars/rancher-vars.yml
  tags: always

- name: get nodes list
  kubernetes.core.k8s_info:
    kind: Node
  register: node_list
  failed_when: false
  delegate_to: localhost

- name: debug nodes list json
  debug:
    var: installed_node_names
  register: server_ip_list

- name: Install NFS for worker nodes
  ansible.builtin.apt:
    name: nfs-common
    state:
      present
  when:
    - inventory_hostname not in installed_node_names
    - RKE_ROLE == "worker"

- epfl_si.rancher.rancher_registration:
    rancher_manager_url: "https://{{ RKE_INSTALL_SERVER }}"
    cluster_name: "{{ wpn_namespace }}"
  register: _token_etc
  delegate_to: localhost
  run_once: true

- debug:
    msg: "{{ _token_etc.registration.nodeCommand }}"
  run_once: true

- name: Configure control node
  ansible.builtin.shell:
    cmd: "{{ _token_etc.registration.nodeCommand }} --etcd --controlplane"
  when:
    - inventory_hostname not in installed_node_names
    - RKE_ROLE == "control"
  register: _control_nodes

- name: Configure worker node
  ansible.builtin.shell:
    cmd: "{{ _token_etc.registration.nodeCommand }} --worker"
  when:
    - inventory_hostname not in installed_node_names
    - RKE_ROLE == "worker"

- when: _control_nodes is changed
  pause:
    prompt: "Please download the kubeconfig from Rancher and export it in the console: export KUBECONFIG=~/Downloads/wordpress-test.yaml"
