- include_vars: ../vars/rancher-vars.yml
  tags: always

- name: get nodes list
  kubernetes.core.k8s_info:
    kind: Node
    namespace: "{{ wpn_namespace }}"
  register: node_list
  delegate_to: localhost

- name: debug nodes list json
  debug:
    msg: "{{ node_list.resources | map(attribute='metadata.name') | join(',') }}"
  register: server_ip_list

- name: Install NFS for worker nodes
  ansible.builtin.apt:
    name: nfs-common
    state:
      present
  when:
    - inventory_hostname not in (node_list.resources | map(attribute='metadata.name'))
    - RKE_ROLE == "worker"

- epfl_si.rancher.rancher_registration:
    rancher_manager_url: "https://{{ RKE_INSTALL_SERVER }}"
    cluster_name: "{{ wpn_namespace }}"
  register: _token_etc
  delegate_to: localhost
  run_once: true

- debug:
    msg: "{{ _token_etc.registration.nodeCommand }}"
  run_once: true

- name: Configure control node
  ansible.builtin.shell:
    cmd: "{{ _token_etc.registration.nodeCommand }} --etcd --controlplane"
  when:
    - inventory_hostname not in (node_list.resources | map(attribute='metadata.name'))
    - RKE_ROLE == "control"

- name: Configure worker node
  ansible.builtin.shell:
    cmd: "{{ _token_etc.registration.nodeCommand }} --worker"
  when:
    - inventory_hostname not in (node_list.resources | map(attribute='metadata.name'))
    - RKE_ROLE == "worker"
