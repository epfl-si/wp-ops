- tags: always
  include_vars:
    file: build-secrets.yml
    name: build_secrets

- tags: always
  include_vars:
    file: github-credentials.yml
    name: github_credentials

- name: wp-base/Secret - Push Secret
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Secret
      type: kubernetes.io/dockerconfigjson
      metadata:
        name: tekton-push
        namespace: "{{ inventory_namespace }}"
      data:
        .dockerconfigjson: "{{ _tekton_push_secret_config | to_json | b64encode }}"
  vars:
    _quay_basic_auth: "{{ build_secrets.quay_push_credentials.name }}:{{ build_secrets.quay_push_credentials.password | eyaml(build_secrets.eyaml_keys) }}"
    _tekton_push_secret_config:
      auths:
        "quay-its.epfl.ch":
          "auth": "{{ _quay_basic_auth | b64encode }}"

- name: GitHub App secrets
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: wp-ci-github-app-secrets
        namespace: "{{ inventory_namespace }}"
      type: Opaque
      stringData:
        APP_ID: "{{ github_credentials.id | string }}"
        PRIVATE_KEY: "{{ github_credentials.private_key | eyaml(github_credentials.eyaml_keys) }}"
