- tags: always
  include_vars: "{{ item }}"
  with_items:
    - quay-vars.yml
    - kong-vars.yml
    - mirrors-vars.yml

- tags: always
  include_vars:
    name: runner_credentials
    file: ../../vars/runner-credentials.yml

- name: "Mirror the Kong image"
  run_once: true
  epfl_si.quay.quay_repository:
    name: "{{ kong_image_mirrored.shortname }}"
    organization: "{{ quay_organization }}"
    description: "Mirrored from {{ kong_image }}"
    visibility: public
    mirror:
      from: "{{ _mirrored_from_short }}"
      robot_account: "{{ mirrorist_quay_robot_account }}"
      tags: ["{{ _mirrored_from_tag }}"]
  vars:
    _mirrored_from_short: >-
      {{ kong_image | split(":") | first }}
    _mirrored_from_tag: >-
      {{ kong_image | split(":") | last | string }}

- name: "Access matrix to {{ kong_image | split(":") | first }}"
  run_once: true
  epfl_si.quay.robot_account_permission:
    robot_account_name: "{{ item.robot_account }}"
    organization: "{{ quay_organization }}"
    repository_name: "{{ kong_image_mirrored.shortname }}"
    permission: "{{ item.permission }}"
  with_items:
    - robot_account: "{{ mirrorist_quay_robot_account }}"
      permission: write
    - robot_account: "{{ quay_puller_robot_account_name }}"
      permission: read

- name: "`ConfigMap/kong-fruit-salad`"
  register: _kong_configmap
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: "kong-fruit-salad"
        namespace: "{{ inventory_namespace }}"
      data:
        kong.yml: "{{ lookup('template', 'kong.yml' ) }}"

- name: "`Deployment/kong-fruit-salad`"
  register: _kong_deployment
  kubernetes.core.k8s:
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: kong-fruit-salad
        namespace: "{{ inventory_namespace }}"
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: kong-fruit-salad
        template:
          metadata:
            labels:
              app: kong-fruit-salad
          spec:
            containers:
              - name: kong
                image: "{{ kong_image_mirrored.qualified }}"
                resources:
                  requests:
                    cpu: "20m"
                    memory: "400Mi"
                ports:
                  - containerPort: 8080
                    protocol: TCP
                env:
                  - name: KONG_DATABASE
                    value: "off"
                  - name: KONG_PLUGINS
                    value: bundled
                  - name: KONG_DECLARATIVE_CONFIG
                    value: /kongfig/kong.yml
                volumeMounts:
                  - mountPath: /kongfig
                    name: kong-fruit-salad
            volumes:
              - name: kong-fruit-salad
                configMap:
                  name: kong-fruit-salad

- tags: wp.base.kong.restart
  when: >-
    (
      (_kong_configmap | default({}) is changed)
      and not
      (_kong_deployment | default({}) is changed)
    )
    or ("wp.base.kong.restart" in ansible_run_tags)
  name: "Redeploy Kong"
  shell:
    cmd: |
      set -e -x
      export KUBECONFIG=$K8S_AUTH_KUBECONFIG
      kubectl -n {{ inventory_namespace }} rollout restart deploy/kong-fruit-salad

- name: Service/kong-fruit-salad
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: kong-fruit-salad
        namespace: "{{ inventory_namespace }}"
        labels:
          app: kong-fruit-salad
      spec:
        type: ClusterIP
        ports:
        - name: "https"
          port: 8443
          protocol: TCP
          targetPort: 8443
        selector:
          app: kong-fruit-salad

- name: Route/kong-pomme
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: route.openshift.io/v1
      kind: Route
      metadata:
        name: kong-pomme
        namespace: "{{ inventory_namespace }}"
        labels:
          app: kong-fruit-salad
          route: private
      spec:
        host: wpn-pomme.epfl.ch
        to:
          kind: Service
          name: kong-fruit-salad
        port:
          targetPort: https
        tls:
          termination: passthrough
          insecureEdgeTerminationPolicy: Redirect
