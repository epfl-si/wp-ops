- tags: always
  include_vars: build-vars.yml

- name: "`ServiceAccount/{{ build_service_account }}`"
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: "{{ build_service_account }}"
        namespace: "{{ inventory_namespace }}"
      imagePullSecrets:
        - name: svc0041-svc0041-puller-pull-secret

- name: Mirror images used to build `FROM`
  include_tasks:
    file: mirrors.yml
    apply:
      tags:
        - wp.base.mirrors
  tags:
    - wp.base.mirrors

- name: Toolbox image
  include_tasks:
    file: _buildconfig.yml
    apply:
      tags:
      - wp.toolbox
      - wp.build.toolbox
  vars:
    buildconfig_name: build-toolbox
    buildconfig_description: Image with git, jq, bash etc. for build-related tasks
    buildconfig_base: "{{ ansible_quay_hostname }}/{{ quay_organization }}/ubuntu:noble"
    buildconfig_source:
      type: Git
      git:
        uri: "https://github.com/epfl-si/wp-ops"
        ref: "feature/wp-base-cloud-tekton-build"   # TODO: remove upon merging
      contextDir: docker/build-toolbox
    buildconfig_rebuild_tags:
    - wp.toolbox.rebuild
    - wp.build.toolbox.rebuild
  tags:
    - wp.toolbox
    - wp.build.toolbox
    - wp.toolbox.rebuild
    - wp.build.toolbox.rebuild

- name: wp-base/Tekton
  include_tasks:
    file: tekton.yml
    apply:
      tags:
        - wp.base.build
        - wp.base.tekton
        - wp.tekton
  tags:
    - wp.base.build
    - wp.base.tekton
    - wp.tekton
    - wp.tekton.pipeline
    - wp.base.tekton.toolbox.rebuild

- name: Kong reverse proxy for blue/green(/red/yellow/orange) testing
  include_tasks:
    file: continuous-integration.yml
    apply:
      tags:
        - wp.ci
        - wp.ci.kong
        - wp.continuous-integration
        - wp.continuous-integration.kong
  tags:
        - wp.ci
        - wp.ci.kong
        - wp.continuous-integration
        - wp.continuous-integration.kong
        - wp.continuous-integration.kong.rebuild
        - wp.continuous-integration.kong.restart
        - wp.continuous-integration.rebuild
        - wp.continuous-integration.restart
