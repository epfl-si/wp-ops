- name: wp-base/RBAC
  include_tasks:
    file: rbac.yml
    apply:
      tags:
        - wp.base.build
        - wp.base.rbac
  tags:
    - wp.base.build
    - wp.base.rbac

- name: wp-base/Secrets
  include_tasks:
    file: secrets.yml
    apply:
      tags:
        - wp.base.build
        - wp.base.secrets
  tags:
    - wp.base.build
    - wp.base.secrets

- name: Mirror images used to build `FROM`
  include_tasks:
    file: mirrors.yml
    apply:
      tags:
        - wp.base.mirrors
  tags:
    - wp.base.mirrors

- name: Toolbox image
  include_tasks:
    file: _buildconfig.yml
    apply:
      tags:
      - wp.toolbox
      - wp.build.toolbox
  vars:
    buildconfig_name: build-toolbox
    buildconfig_description: Image with git, jq, bash etc. for build-related tasks
    buildconfig_base: "{{ ansible_quay_hostname }}/{{ quay_organization }}/ubuntu:noble"
    buildconfig_source:
      type: Git
      git:
        uri: "https://github.com/epfl-si/wp-ops"
        ref: "feature/wp-base-cloud-tekton-build"   # TODO: remove upon merging
      contextDir: docker/build-toolbox
    buildconfig_rebuild_tags:
    - wp.toolbox.rebuild
    - wp.build.toolbox.rebuild
  tags:
    - wp.toolbox
    - wp.build.toolbox
    - wp.toolbox.rebuild
    - wp.build.toolbox.rebuild

- name: wp-base/Tekton
  include_tasks:
    file: tekton.yml
    apply:
      tags:
        - wp.base.build
        - wp.base.tekton
        - wp.tekton
  tags:
    - wp.base.build
    - wp.base.tekton
    - wp.tekton
    - wp.tekton.pipeline
    - wp.base.tekton.toolbox.rebuild

- name: Kong reverse proxy for blue/green(/red/yellow/orange) testing
  include_tasks:
    file: continuous-integration.yml
    apply:
      tags:
        - wp.ci
        - wp.ci.kong
        - wp.continuous-integration
        - wp.continuous-integration.kong
  tags:
        - wp.ci
        - wp.ci.kong
        - wp.continuous-integration
        - wp.continuous-integration.kong
        - wp.continuous-integration.kong.rebuild
        - wp.continuous-integration.kong.restart
        - wp.continuous-integration.rebuild
        - wp.continuous-integration.restart

- name: wp-cron cloud build
  include_tasks:
    file: _buildconfig.yml
    apply:
      tags:
      - wp.cron
  vars:
    buildconfig_name: wp-cron
    buildconfig_description: Periodic jobs (“cron”) for WordPress, incl. monitoring and operator reconciliation loop
    buildconfig_base: "{{ ansible_quay_hostname }}/{{ quay_organization }}/ubuntu:noble"
    buildconfig_source:
      type: Git
      git:
        uri: "https://github.com/epfl-si/wp-ops"
        ref: "feature/wp-base-cloud-tekton-build"   # TODO: remove upon merging
      contextDir: docker/wp-cron
    buildconfig_rebuild_tags:
    - wp.cron.rebuild
  tags:
    - wp.cron
    - wp.cron.rebuild

- name: wp-operator cloud build
  include_tasks:
    file: _buildconfig.yml
    apply:
      tags:
      - wp.operator
  vars:
    buildconfig_name: wp-operator
    buildconfig_description: WordPress operator
    buildconfig_base: "{{ ansible_quay_hostname }}/{{ quay_organization }}/ubuntu:jammy"
    buildconfig_source:
      type: Git
      git:
        uri: "https://github.com/epfl-si/wp-operator"
        ref: "feature/allowFieldsUpdate"   # TODO: remove upon merging
    buildconfig_rebuild_tags:
    - wp.operator.rebuild
  tags:
    - wp.operator
    - wp.operator.rebuild
