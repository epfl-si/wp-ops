- tags: always
  include_vars: "{{ item }}"
  with_items:
    - build-vars.yml
    - tekton-vars.yml

- name: wp-base/Tekton RBAC - Role
  kubernetes.core.k8s:
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: Role
      metadata:
        name: "{{ build_service_account }}-role"
        namespace: "{{ inventory_namespace }}"
      rules:
        - apiGroups: ["tekton.dev"]
          resources: ["pipelineruns"]
          verbs: ["create", "get", "list", "patch"]
        - apiGroups: [""]
          resources: ["persistentvolumeclaims"]
          verbs: ["create", "get", "list", "patch"]
        - apiGroups: ["apps"]
          resources: ["deployments"]
          verbs: ["create", "get", "list", "patch"]

- name: wp-base/Tekton - RoleBinding
  kubernetes.core.k8s:
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: "{{ build_service_account }}-rolebinding"
        namespace: "{{ inventory_namespace }}"
      subjects:
        - kind: ServiceAccount
          name: "{{ build_service_account }}"
          namespace: "{{ inventory_namespace }}"
      roleRef:
        kind: Role
        name: "{{ build_service_account }}-role"
        apiGroup: rbac.authorization.k8s.io
