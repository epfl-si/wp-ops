- tags: always
  include_vars: tekton-vars.yml

- name: wp-base/Image - Builder Service Account
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: "{{ wp_base_builder_service_account }}"
        namespace: "{{ inventory_namespace }}"
      imagePullSecrets:
        - name: svc0041-svc0041-puller-pull-secret

- name: wp-base/Tekton RBAC - Role
  kubernetes.core.k8s:
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: Role
      metadata:
        name: "{{ wp_base_builder_service_account }}-role"
        namespace: "{{ inventory_namespace }}"
      rules:
        - apiGroups: ["tekton.dev"]
          resources: ["pipelineruns"]
          verbs: ["create", "get", "list", "patch"]
        - apiGroups: [""]
          resources: ["persistentvolumeclaims"]
          verbs: ["create", "get", "list", "patch"]

- name: wp-base/Tekton - RoleBinding
  kubernetes.core.k8s:
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: "{{ wp_base_builder_service_account }}-rolebinding"
        namespace: "{{ inventory_namespace }}"
      subjects:
        - kind: ServiceAccount
          name: "{{ wp_base_builder_service_account }}"
          namespace: "{{ inventory_namespace }}"
      roleRef:
        kind: Role
        name: "{{ wp_base_builder_service_account }}-role"
        apiGroup: rbac.authorization.k8s.io

- name: wp-base/Tekton - RoleBinding for `anyuid`
  kubernetes.core.k8s:
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: RoleBinding
      metadata:
        name: allow-anyuid
        namespace: "{{ inventory_namespace }}"
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: pipelines-scc-clusterrole
      subjects:
          - kind: ServiceAccount
            name: "{{ wp_base_builder_service_account }}"
            namespace: "{{ inventory_namespace }}"
