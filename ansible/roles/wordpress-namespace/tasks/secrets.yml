- tags: always
  include_vars: "{{ item }}"
  with_items:
  - serving-secrets-{{ inventory_deployment_stage }}.yml
  - secrets-vars.yml
  - s3_secrets_vars.yml

- name: "SMTP password"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: "smtp-password"
        namespace: "{{ inventory_namespace }}"
      data:
         SERVICE_WWP_NOREPLY_PASSWORD: "{{ smtp.password | eyaml(eyaml_keys) | b64encode }}"
  tags: httpd.secrets

- name: Scality restore secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: restore-credentials
        namespace: "{{ inventory_namespace }}"
      type: Opaque
      stringData:
        aws-cli-credentials.ini: >-
          {{ lookup("pipe", "keybase fs read " + keybase_restore_secret_path) }}

- name: EPFL plugin secrets
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: wp-plugin-secrets
        namespace: "{{ inventory_namespace }}"
      type: Opaque
      stringData:
        restauration_api_password: "{{ restauration.api_password | eyaml(eyaml_keys) }}"
        wpforms_license: "{{ wpforms.license_key | eyaml(eyaml_keys) }}"
        saferpay_test_apiusername: "{{ saferpay.test.apiusername | eyaml(eyaml_keys) }}"
        saferpay_test_apipassword: "{{ saferpay.test.apipassword | eyaml(eyaml_keys) }}"
        saferpay_test_customerid: "{{ saferpay.test.customerid | eyaml(eyaml_keys) | string }}"
        saferpay_test_terminalid: "{{ saferpay.test.terminalid | eyaml(eyaml_keys) | string }}"
        saferpay_prod_apiusername: "{{ saferpay.prod.apiusername | eyaml(eyaml_keys) }}"
        saferpay_prod_customerid: "{{ saferpay.prod.customerid | eyaml(eyaml_keys) | string }}"
        saferpay_prod_terminalid: "{{ saferpay.prod.terminalid | eyaml(eyaml_keys) | string }}"

- name: MariaDB operator restore secret (OS3)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: s3-backup-credentials
        namespace: "{{ inventory_namespace }}"
      type: Opaque
      stringData:
        keyId: "{{ s3_bucket['os3']['production']['keyId'] }}"
        accessSecret: "{{ s3_bucket['os3']['production']['accessSecret'] }}"

- name: MariaDB operator backup secret (OS4)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: s3-credentials-for-os4
        namespace: "{{ inventory_namespace }}"
      type: Opaque
      stringData:
        keyId: "{{ s3_bucket['os4'][inventory_deployment_stage]['keyId'] }}"
        accessSecret: "{{ s3_bucket['os4'][inventory_deployment_stage]['accessSecret'] }}"
