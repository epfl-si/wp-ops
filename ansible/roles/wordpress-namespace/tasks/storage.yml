
- when: _storage_managed
  name: PersistentVolume/wp-data
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: PersistentVolume
      metadata:
        name: wp-data
      spec:
        accessModes:
        - ReadWriteMany
        capacity:
          # This counts towards our OpenShift quota (despite the
          # metering happening on different hardware altogether), so
          # we want to pretend it costs almost nothing:
          storage: 1Gi
        volumeMode: Filesystem
        nfs:
          server: nas-app-ma-nfs1.epfl.ch
          path: /svc0041_si_openshift_app_wwp_test_app/wp-data
        claimRef:
          kind: PersistentVolumeClaim
          namespace: "{{ inventory_namespace }}"
          name: wp-data

- name: PersistentVolumeClaim/wp-data
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: wp-data
        namespace: "{{ inventory_namespace }}"
      spec:
        accessModes:
          - ReadWriteMany
        resources:
          requests:
            storage: 1Gi

# During the transition period, we can read from the old volumes:

- when: _storage_managed
  name: PersistentVolume/wp-data-ro-openshift3
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: PersistentVolume
      metadata:
        name: wp-data-ro-openshift3
      spec:
        accessModes:
        - ReadOnlyMany
        capacity:
          storage: 1Gi
        volumeMode: Filesystem
        nfs:
          server: nas-app-ma-nfs1.epfl.ch
          path: /si_openshift_app_wwp_app/wordpress
          readOnly: true
        claimRef:
          kind: PersistentVolumeClaim
          namespace: "{{ inventory_namespace }}"
          name: wp-data-ro-openshift3

- name: PersistentVolumeClaim/wp-data-ro-openshift3
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: wp-data-ro-openshift3
        namespace: "{{ inventory_namespace }}"
      spec:
        accessModes:
          - ReadOnlyMany
        resources:
          requests:
            storage: 1Gi
