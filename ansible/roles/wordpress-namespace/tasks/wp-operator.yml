- tags: always
  include_vars: "{{ item }}"
  with_items:
  - ../../../vars/quay-vars.yml
  - s3-secrets-vars.yml

# Required for quay-vars.yml, above:
- tags: always
  include_vars:
    file: ../../../vars/quay-secrets.yml
    name: quay_secrets

- name: ConfigMap/wp-backups
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: wp-backups
        namespace: "{{ inventory_namespace }}"
      data:
        S3_BACKUP_BUCKET: "{{ s3_backup_credentials.bucket_name }}"

- name: ConfigMap/epfl-migration
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: epfl-migration
        namespace: "{{ inventory_namespace }}"
      data:
        EPFL_MIGRATION_BUCKET: "{{ s3_epfl_migration_credentials.bucket_name }}"

- name: Credentials required to restore from previous (OpenShift 3) production backups
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: epfl-migration
        namespace: "{{ inventory_namespace }}"
      type: Opaque
      stringData:
        EPFL_MIGRATION_KEYID: "{{ s3_epfl_migration_credentials.keyId }}"
        EPFL_MIGRATION_ACCESSSECRET: "{{ s3_epfl_migration_credentials.accessSecret }}"
        RESTIC_PASSWORD: "{{ s3_epfl_migration_credentials.resticPassword }}"

- name: Pull secret for the OLM operator
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Secret
      type: kubernetes.io/dockerconfigjson
      metadata:
        # Name must match the one that the operator Deployment
        # wants to use; see
        # https://github.com/epfl-si/wp-operator/blob/main/operator-namespaced.yaml
        name: wp-operator-pull
        namespace: "{{ inventory_namespace }}"
      stringData:
        .dockerconfigjson: >-
          {{ lookup("epfl_si.quay.robot_account", quay_organization, quay_puller_robot_account_name,
                                                  token=quay_botfather_token)
          | epfl_si.quay.format_docker_config_json | string }}
  

- name: "Deployment/wp-operator (on the “prod” image)"
  when: >-
    inventory_deployment_stage == "production"
  kubernetes.core.k8s_json_patch:
      api_version: apps/v1
      kind: Deployment
      name: wp-operator
      namespace: "{{ inventory_namespace }}"
      patch:
       - op: replace
         path: /spec/template/spec/containers/0/image
         value: quay-its.epfl.ch/svc0041/wp-operator:prod
