---

- name: Log in to cluster
  tags: always
  import_tasks:
    file: k8s-login.yml

- name: MariaDB server
  include_tasks:
    file: mariadb.yml
    apply:
      tags:
        - wp
        - wp.mariadb
  tags:
    - wp
    - wp.mariadb

- name: Storage (for files)
  include_tasks:
    file: storage.yml
    apply:
      tags:
      - wp
      - wp.storage
  tags:
    - wp
    - wp.storage
  vars:
    # Setting up the PV (and managing access to it, so that other
    # tenants cannot “steal” it from us) is for ITOP-SDDC to manage:
    _storage_managed: >-
      {{ inventory_has_cluster_admin | default(False) }}

- name: Serving secrets (for plugins, outgoing SMTP etc.)
  include_tasks:
    file: secrets.yml
    apply:
      tags:
      - wp
      - wp.secrets
  tags:
    - wp
    - wp.secrets

- name: Web server
  include_tasks:
    file: nginx.yml
    apply:
      tags:
        - wp
        - wp.web
        - wp.nginx
      vars:
        # We want to manage RBAC in RKE2 clusters only — OpenShifts
        # (and OKDs) use OLM as the RBAC vehicle instead:
        _rbac_managed: >-
          {{ "rke2_namespaces" in group_names }}
        # For now, we manage Routes by hand (so as to revert them quickly if need be):
        _routing_managed: >-
          {{ "rke2_namespaces" in group_names }}
  tags:
    - wp
    - wp.web
    - wp.nginx

- name: Cloudflare Settings
  when: >-
    "openshift_namespaces_prod" in group_names
  include_tasks:
    file: cloudflare-settings.yml
    apply:
      tags:
      - cloudflare-settings
  tags:
    - cloudflare-settings
    - cloudflare-settings.tls
    - cloudflare-settings.tls.verify-token
    - cloudflare-settings.tls.list-ciphers
    - cloudflare-settings.tls.update-ciphers
    - cloudflare-settings.tls.reset-ciphers
    - cloudflare-settings.rulesets
    - cloudflare-settings.rulesets.verify-token
    - cloudflare-settings.rulesets.list
    - cloudflare-settings.rulesets.update-response-header-transform-rules
