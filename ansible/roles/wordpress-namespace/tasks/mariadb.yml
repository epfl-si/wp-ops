- tags: always
  include_vars:
    file : "{{ item }}"
  with_items:
    - mariadb-vars.yml
    - s3-secrets-vars.yml
    - ../../../vars/quay-vars.yml

- name: 'MariaDBOperator/mariadb-operator'
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: helm.mariadb.mmontes.io/v1alpha1
      kind: MariadbOperator
      metadata:
        name: mariadb-operator
        namespace: "{{ inventory_namespace }}"
      spec:
        name: mariadb-operator
        resources:
          requests:
            cpu: 100m
            memory: 100M
        webhook:
          resources:
            requests:
              cpu: 100m
              memory: 100M
        certController:
         resources:
           requests:
             cpu: 100m
             memory: 100M

- name: "MariaDB/{{ mariadb_name }}-0x with StorageClass {{ mariadb_storage_class }}"
  with_sequence: >-
    {{ "1-" + number_of_mariadb|string if inventory_namespace == "svc0041p-wordpress"
        else "1-2" }}
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: MariaDB
      metadata:
        name: "{{ mariadb_name }}-{{ '%02d' | format(item|int) }}"
        namespace: "{{ inventory_namespace }}"
        labels:
          wpAutoallocate: 'true'
      spec:
        storage:
          size: 1Gi
          storageClassName: "{{ mariadb_storage_class }}"
          volumeClaimTemplate:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
            storageClassName: "{{ mariadb_storage_class }}"
        resources:
          requests:
            cpu: >-
              {{ "500m" if inventory_deployment_stage == "production"
                 else "50m" }}
            memory: 2Gi
          limits:
            memory: 2Gi
        rootPasswordSecretKeyRef:
          name: mariadb
          key: root-password
          generate: true
        metrics:
          enabled: true
          exporter:
            image: quay-its.epfl.ch/svc0041/mysqld-exporter:v0.15.1
            resources:
              requests:
                cpu: 50m
                memory: 64Mi

- name: "Backup/{{ mariadb_name }} (Backups scheduling)"
  with_sequence: >-
    {{ "1-" + number_of_mariadb|string if inventory_namespace == "svc0041p-wordpress"
        else "1-2" }}
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: Backup
      metadata:
        name: "{{ mariadb_name }}-{{ '%02d' | format(item|int) }}"
        namespace: "{{ inventory_namespace }}"
      spec:
        mariaDbRef:
          name: "{{ mariadb_name }}-{{ '%02d' | format(item|int) }}"
        schedule:
          cron: "0 {{ item|int }} * * *"
          suspend: false
        args:
          # Note: our volume comes from a NetApp share that has
          #       snapshotting acitvated. This means that `.snapshot` folders
          #       pop up randomly in every directory, causing this error:
          #
          #         `mariadb-dump: Got error: 1102: "Incorrect database name
          #           '#mysql50#.snapshot'" when selecting the database`
          #
          #       The following line works around that.
          - '--ignore-database=#mysql50#.snapshot'
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: >-
              {{ "200m" if inventory_deployment_stage == "production"
                 else "50m" }}
            memory: 64Mi
        maxRetention: 8760h
        storage:
          s3:
            bucket: "{{ s3_backup_credentials.bucket_name }}"
            prefix: "MariaDB-{{ mariadb_name }}-{{ '%02d' | format(item|int) }}"
            endpoint: s3.epfl.ch
            accessKeyIdSecretKeyRef:
              name: s3-backup-credentials
              key: keyId
            secretAccessKeySecretKeyRef:
              name: s3-backup-credentials
              key: accessSecret
            tls:
              enabled: true

- name: "Restore nightly sites from prod to test"
  when: >-
    inventory_deployment_stage == "test"
  include_tasks: restore-sites-prod-to-test.yml


- name: "MariaDB/{{ mariadb_name }}-[fleet/restore] with StorageClass {{ mariadb_storage_class }}"
  with_items:
    - fleet
    - restore
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: MariaDB
      metadata:
        name: "{{ mariadb_name }}-{{ item }}"
        namespace: "{{ inventory_namespace }}"
      spec:
        storage:
          size: 1Gi
          storageClassName: "{{ mariadb_storage_class }}"
          volumeClaimTemplate:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
            storageClassName: "{{ mariadb_storage_class }}"
        resources:
          requests:
            cpu: >-
              {{ "500m" if inventory_deployment_stage == "production"
                 else "50m" }}
            memory: 200Mi
          limits:
            memory: 2Gi
        rootPasswordSecretKeyRef:
          name: mariadb
          key: root-password
          generate: true
        metrics:
          enabled: true
          exporter:
            image: quay-its.epfl.ch/svc0041/mysqld-exporter:v0.15.1
            resources:
              requests:
                cpu: 50m
                memory: 64Mi

- name: "Backup/{{ mariadb_name }}-fleet (Backups scheduling)"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: Backup
      metadata:
        name: "{{ mariadb_name }}-fleet"
        namespace: "{{ inventory_namespace }}"
      spec:
        mariaDbRef:
          name: "{{ mariadb_name }}-fleet"
        schedule:
          cron: "0 6 * * *"
          suspend: false
        args:
          # Note: our volume comes from a NetApp share that has
          #       snapshotting acitvated. This means that `.snapshot` folders
          #       pop up randomly in every directory, causing this error:
          #
          #         `mariadb-dump: Got error: 1102: "Incorrect database name
          #           '#mysql50#.snapshot'" when selecting the database`
          #
          #       The following line works around that.
          - '--ignore-database=#mysql50#.snapshot'
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: >-
              {{ "200m" if inventory_deployment_stage == "production"
                 else "50m" }}
            memory: 64Mi
        # This is the default:
        maxRetention: 720h
        storage:
          s3:
            bucket: "{{ s3_backup_credentials.bucket_name }}"
            prefix: "MariaDB-{{ mariadb_name }}-fleet"
            endpoint: s3.epfl.ch
            accessKeyIdSecretKeyRef:
              name: s3-backup-credentials
              key: keyId
            secretAccessKeySecretKeyRef:
              name: s3-backup-credentials
              key: accessSecret
            tls:
              enabled: true

- name: "Database/{{ _fleet_name }}"
  with_items:
    - fleet
    - restore
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: Database
      metadata:
        name: >-
          {{ "wp-fleet" if item == "fleet"
          else "wp-fleet-restore" }}
        namespace: "{{ inventory_namespace }}"
      spec:
        name: "{{ _fleet_name }}"
        characterSet: utf8mb4
        collate: utf8mb4_unicode_ci
        mariaDbRef:
          name: "{{ mariadb_name }}-{{ item }}"
          waitForIt: true

- name: "Secret/{{ _fleet_name }}"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      type: Opaque
      metadata:
        name: "{{ _fleet_name }}"
        namespace: "{{ inventory_namespace }}"
      data:
        password: "{{ _fleet_db_password | b64encode }}"

- name: "User/{{ _fleet_name }}"
  with_items:
    - fleet
    - restore
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: User
      metadata:
        name: "wp-{{ item }}"
        namespace: "{{ inventory_namespace }}"
      spec:
        cleanupPolicy: Delete
        host: '%'
        mariaDbRef:
          name: "{{ mariadb_name }}-{{ item }}"
          waitForIt: true
        maxUserConnections: 10
        passwordSecretKeyRef:
          key: password
          name: "{{ _fleet_name }}"

- name: "Grant/{{ _fleet_name }}"
  with_items:
    - fleet
    - restore
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: Grant
      metadata:
        name: "wp-{{ item }}"
        namespace: "{{ inventory_namespace }}"
      spec:
        database: "{{ _fleet_name }}"
        grantOption: false
        host: '%'
        mariaDbRef:
          name: "{{ mariadb_name }}-{{ item }}"
          waitForIt: true
        privileges:
          - ALL PRIVILEGES
        table: '*'
        username: "wp-{{ item }}"
