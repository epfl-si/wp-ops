- tags: always
  include_vars:
    file : "backup-secrets-{{ inventory_deployment_stage }}.yml"

- name: "`MariaDB/mariadb-min`"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: MariaDB
      metadata:
        name: mariadb-min
        namespace: "{{ inventory_namespace }}"
      spec:
        storage:
          size: 2G
        rootPasswordSecretKeyRef:
          name: mariadb
          key: root-password
          generate: true
        metrics:
          enabled: true

- name: "MariaDB cron job for backups"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: Backup
      metadata:
        namespace: "{{ inventory_namespace }}"
        name: backup-mariadb
      spec:
        mariaDbRef:
          name: mariadb-min
        schedule:
          cron: "0 3 */1 * *"
          suspend: false
        storage:
          s3:
            bucket: "{{ s3_bucket }}"
            prefix: backup/wpn
            endpoint: s3.epfl.ch
            accessKeyIdSecretKeyRef:
              name: s3-backup-credentials
              key: keyId
            secretAccessKeySecretKeyRef:
              name: s3-backup-credentials
              key: accessSecret
            tls:
              enabled: true
