- tags: always
  include_vars:
    file : "{{ item }}"
  with_items: 
    - mariadb-vars.yml
    - "backup-secrets-{{ inventory_deployment_stage }}.yml"

- name: "MariaDB/{{ mariadb_name }} with StorageClass {{ storage_class_to_use }}"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: MariaDB
      metadata:
        name: "{{ mariadb_name }}"
        namespace: "{{ inventory_namespace }}"
      spec:
        storage:
          size: 100Gi
          storageClassName: "{{ storage_class_to_use }}"
          volumeClaimTemplate:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 100Gi
            storageClassName: "{{ storage_class_to_use }}"
        rootPasswordSecretKeyRef:
          name: mariadb
          key: root-password
          generate: true
        metrics:
          enabled: true

- name: "Backup/{{ mariadb_name }} (Backups scheduling)"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: Backup
      metadata:
        name: "{{ mariadb_name }}"
        namespace: "{{ inventory_namespace }}"
      spec:
        mariaDbRef:
          name: "{{ mariadb_name }}"
        schedule:
          cron: "0 1 * * *"
          suspend: false
        storage:
          s3:
            bucket: "{{ s3_bucket }}"
            prefix: MariaDB
            endpoint: s3.epfl.ch
            accessKeyIdSecretKeyRef:
              name: s3-backup-credentials
              key: keyId
            secretAccessKeySecretKeyRef:
              name: s3-backup-credentials
              key: accessSecret
            tls:
              enabled: true
