- tags: always
  include_vars:
    file : "{{ item }}"
  with_items: 
    - mariadb-vars.yml
    - "backup-secrets-{{ inventory_deployment_stage }}.yml"

- name: "MariaDB/{{ mariadb_name }}-0x with StorageClass {{ storage_class_to_use }}"
  with_sequence: >-
    {{ "1-" + number_of_mariadb|string if inventory_namespace == "svc0041p-wordpress"
        else "1-2" }}
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: MariaDB
      metadata:
        name: "{{ mariadb_name }}-{{ '%02d' | format(item|int) }}"
        namespace: "{{ inventory_namespace }}"
      spec:
        storage:
          size: 1Gi
          storageClassName: "{{ storage_class_to_use }}"
          volumeClaimTemplate:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
            storageClassName: "{{ storage_class_to_use }}"
        rootPasswordSecretKeyRef:
          name: mariadb
          key: root-password
          generate: true
        metrics:
          enabled: true

- name: "Backup/{{ mariadb_name }} (Backups scheduling)"
  with_sequence: >-
    {{ "1-" + number_of_mariadb|string if inventory_namespace == "svc0041p-wordpress"
        else "1-2" }}
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: k8s.mariadb.com/v1alpha1
      kind: Backup
      metadata:
        name: "{{ mariadb_name }}-{{ '%02d' | format(item|int) }}"
        namespace: "{{ inventory_namespace }}"
      spec:
        mariaDbRef:
          name: "{{ mariadb_name }}-{{ '%02d' | format(item|int) }}"
        schedule:
          cron: "0 {{ item|int }} * * *"
          suspend: false
        args:
          # Note: our volume comes from a NetApp share that has
          #       snapshotting acitvated. This means that `.snapshot` folders
          #       pop up randomly in every directory, causing this error:
          #
          #         `mariadb-dump: Got error: 1102: "Incorrect database name 
          #           '#mysql50#.snapshot'" when selecting the database`
          #
          #       The following line works around that.
          - '--ignore-database=#mysql50#.snapshot'
        resources:
          limits:
            cpu: 300m
            memory: 512Mi
          requests:
            cpu: >-
              {{ "200m" if inventory_deployment_stage == "prod"
                 else "50m" }}
            memory: 64Mi
        # This is the default:
        maxRetention: 720h
        storage:
          s3:
            bucket: "{{ s3_bucket }}"
            prefix: "MariaDB-{{ mariadb_name }}-{{ '%02d' | format(item|int) }}"
            endpoint: s3.epfl.ch
            accessKeyIdSecretKeyRef:
              name: s3-backup-credentials
              key: keyId
            secretAccessKeySecretKeyRef:
              name: s3-backup-credentials
              key: accessSecret
            tls:
              enabled: true
