- include_vars: menu-api-vars.yml
  tags: always
- include_vars: image-vars.yml
  tags: always

- name: ConfigMap/menu-api
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: menu-api
        namespace: "{{ inventory_namespace }}"
      data:
        menu-api-config.yaml: |
          WPVERITAS_URL: "https://{{ _wp_veritas_base_url }}/api/v1/sites"
          POD_NAME: "httpd-"
          SERVICE_PORT: "3001"
          PATH_REFRESH_FILE: "./data"
          PATH_SITES_FILE: ""
          NAMESPACE: "{{ inventory_namespace }}"
          DEBUG: {{ _debug }}
          LOCAL_ENV: false
          REST_URL_END: "wp-json/epfl/v1/menus/top?lang="
          LABS_LINK_URL_FR: "https://www.epfl.ch/labs/fr/laboratoires/"
          LABS_LINK_URL_EN: "https://www.epfl.ch/labs/en/laboratories/"
          ASSOC_BREADCRUMB_EN: |
            https://www.epfl.ch/campus/en/campusenglish/
            https://www.epfl.ch/campus/associations/en/student-associations/
            https://www.epfl.ch/campus/associations/list/en/all-associations/
          ASSOC_BREADCRUMB_FR: |
            https://www.epfl.ch/campus/fr/campus/
            https://www.epfl.ch/campus/associations/fr/associations-detudiants/
            https://www.epfl.ch/campus/associations/list/fr/toutes-les-associations/
          MENU_BAR_LINKS_EN: |
            https://www.epfl.ch/about/en/
            https://www.epfl.ch/education/en/
            https://www.epfl.ch/research/en/
            https://www.epfl.ch/innovation/en/
            https://www.epfl.ch/schools/en/
            https://www.epfl.ch/campus/en/
            https://www.epfl.ch/labs/en/
          MENU_BAR_LINKS_FR: |
            https://www.epfl.ch/about/fr/
            https://www.epfl.ch/education/fr/
            https://www.epfl.ch/research/fr/
            https://www.epfl.ch/innovation/fr/
            https://www.epfl.ch/schools/fr/
            https://www.epfl.ch/campus/fr/
            https://www.epfl.ch/labs/fr/
          MENU_BAR_LINKS_DE: |
            https://www.epfl.ch/about/de/
            https://www.epfl.ch/education/de/
            https://www.epfl.ch/research/de/
            https://www.epfl.ch/innovation/de/
            https://www.epfl.ch/schools/de/
            https://www.epfl.ch/campus/de/
            https://www.epfl.ch/labs/en/
  vars:
    _wp_veritas_base_url: >-
      {{ "wp-veritas.epfl.ch" if inventory_namespace == "svc0041p-wordpress"
      else "wp-veritas-test.epfl.ch" }}
    _debug: >-
      {{ false if inventory_namespace == "svc0041p-wordpress"
      else true }}
  register: _menu_api_config_map

- name: Deployment/menu-api
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: menu-api
        namespace: "{{ inventory_namespace }}"
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: menu-api
        template:
          metadata:
            labels:
              app: menu-api
          spec:
            containers:
              - name: menu-api
                image: "quay-its.epfl.ch/svc0041/menu-api:2025-001-{{ inventory_deployment_stage }}"
                resources:
                  limits:
                    cpu: 500m
                    memory: 1Gi
                  requests:
                    cpu: 100m
                    memory: 512Mi
                volumeMounts:
                  - name: menu-api
                    mountPath: /config/
                ports:
                  - containerPort: 3001
            volumes:
              - name: menu-api
                configMap:
                  name: menu-api
            imagePullSecrets:
              - name: "{{ image_pull_secret_name }}"

- name: Service/menu-api
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: menu-api
        namespace: "{{ inventory_namespace }}"
        labels:
          app: menu-api
        annotations:
          authors: isas-fsd
      spec:
        ports:
          - port: 3001
            protocol: TCP
            targetPort: 3001
        selector:
          app: menu-api
        type: ClusterIP
