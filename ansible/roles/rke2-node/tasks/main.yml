- include_vars: ../vars/rancher-vars.yml
  tags: always

- name: configure crictl for interactive use
  ansible.builtin.blockinfile:
    path: /root/.profile
    marker: '# {mark} ANSIBLE MANAGED BLOCK - crictl'
    block: |
      export CRI_CONFIG_FILE=/var/lib/rancher/rke2/agent/etc/crictl.yaml
      export CONTAINERD_ADDRESS=unix:///run/k3s/containerd/containerd.sock
      export PATH=$PATH:/var/lib/rancher/rke2/bin

- name: install kubectl
  community.general.snap:
    name: kubectl
    classic: yes
    channel: latest/stable
  when:
    - RKE_ROLE == "control"

- name: configure kubectl
  ansible.builtin.blockinfile:
    path: /root/.profile
    marker: '# {mark} ANSIBLE MANAGED BLOCK - kubectl'
    block: |
      export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
  when:
    - RKE_ROLE == "control"

- name: Ensure udp-checksum-offload-disable.service
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=Disable udp checksum offload
      Before=rancher-system-agent.service
      [Install]
      WantedBy=rancher-system-agent.service
      [Service]
      Type=oneshot
      RemainAfterExit=true
      ExecStart=ethtool --offload  ens192  rx off  tx off
    dest: /etc/systemd/system/udp-checksum-offload-disable.service
  register: _systemd_config_file

- name: Systemd service
  ansible.builtin.systemd_service:
    name: udp-checksum-offload-disable.service
    state: started
    enabled: true
    daemon_reload: >
      {{ _systemd_config_file | default({}) is changed }} 

- name: get nodes list
  kubernetes.core.k8s_info:
    kind: Node
  register: node_list
  failed_when: false
  delegate_to: localhost

- name: debug nodes list json
  debug:
    var: installed_node_names
  register: server_ip_list

- name: Install NFS for worker nodes
  ansible.builtin.apt:
    name: nfs-common
    state:
      present
  when:
    - inventory_hostname not in installed_node_names
    - RKE_ROLE == "worker"

- epfl_si.rancher.rancher_registration:
    rancher_manager_url: "https://{{ RKE_INSTALL_SERVER }}"
    cluster_name: "{{ wpn_namespace }}"
  register: _token_etc
  delegate_to: localhost
  run_once: true

- debug:
    msg: "{{ _token_etc.registration.nodeCommand }}"
  run_once: true

- name: Configure control node
  ansible.builtin.shell:
    cmd: "{{ _token_etc.registration.nodeCommand }} --etcd --controlplane"
  when:
    - inventory_hostname not in installed_node_names
    - RKE_ROLE == "control"
  register: _control_nodes

- name: Configure worker node
  ansible.builtin.shell:
    cmd: "{{ _token_etc.registration.nodeCommand }} --worker"
  when:
    - inventory_hostname not in installed_node_names
    - RKE_ROLE == "worker"

- when: _control_nodes is changed
  pause:
    prompt: "Please download the kubeconfig from Rancher and export it in the console: export KUBECONFIG=~/Downloads/wordpress-test.yaml"
