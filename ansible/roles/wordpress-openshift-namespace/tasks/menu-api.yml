- name: Menu and breadcrumb API DeploymentConfig
  openshift:
    apiVersion: apps.openshift.io/v1
    kind: DeploymentConfig
    metadata:
      name: menu-api
      namespace: "{{ openshift_namespace }}"
    spec:
      replicas: 1
      selector:
        deployment-config.name: menu-api
      template:
        metadata:
          labels:
            deployment-config.name: menu-api
        spec:
          containers:
            - name: menu-api
              image: 'docker-registry.default.svc:5000/{{ openshift_namespace }}/menu-api:latest'
              imagePullPolicy: Always
              volumeMounts:
                - name: wp-nfs
                  mountPath: /srv/menus
                  subPath: "{{ _subpath }}"
              envFrom:
                - configMapRef:
                    name: menu-api-configmap
          volumes:
            - name: wp-nfs
              persistentVolumeClaim:
                claimName: "wordpress-0"
                readOnly: true
      triggers:
      - type: ImageChange
        imageChangeParams:
          automatic: true
          containerNames:
          - menu-api
          from:
            kind: ImageStreamTag
            name: 'menu-api:latest'
            namespace: "{{ openshift_namespace }}"
  vars:
    _subpath: "{{ _subpaths[openshift_namespace] }}"
    _subpaths:
      wwp: www/www.epfl.ch/htdocs/menu-backups
      wwp-test: .

- name: Menu and breadcrumb API Service
  openshift:
    apiVersion: v1
    kind: Service
    metadata:
      name: menu-api
      namespace: "{{ openshift_namespace }}"
    spec:
      type: ClusterIP
      ports:
        - port: 8080
          protocol: TCP
          targetPort: 3000
      selector:
        deployment-config.name: menu-api

- name: menu-api-configmap ConfigMap
  openshift:
    state: latest
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: menu-api-configmap
    data:
      OPENSHIFT_ENV: |
        - "www"
        - "labs"
      WPVERITAS_URL: "https://wp-veritas.epfl.ch/api/v1/sites"
      MENU_API_PROTOCOL_HOST_PORT: "https://www.epfl.ch"
      SERVICE_PORT: "3001"
      REFRESH_INTERVAL: "600000"
      NODE_TLS_REJECT_UNAUTHORIZED: "0"
      REFRESH_INTERVAL_WITH_FILE: "600000"
      REFRESH_FROM_FILE: "true"
      PATH_REFRESH_FILE: "."
      REST_URL_EDN: "wp-json/epfl/v1/menus/top?lang="
      LABS_LINK_URL_FR: "https://www.epfl.ch/labs/fr/laboratoires/"
      LABS_LINK_URL_EN: "https://www.epfl.ch/labs/en/laboratories/"
      ASSOC_LINK_URL_FR: "https://www.epfl.ch/campus/associations/list/fr/toutes-les-associations/"
      ASSOC_LINK_URL_EN: "https://www.epfl.ch/campus/associations/list/en/all-associations/"

