- name: "fallback-reverse-proxy Service"
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: fallback-reverse-proxy
        namespace: svc0041p-wordpress
      spec:
        type: ExternalName
        # TODO: this would be better if we were going through some
        # *non-*public IP (so that we can shut down this one, and gain
        # some DDOS resilience).
        externalName: www-origin.epfl.ch
        ports:
        - name: https
          port: 443

- name: "fallback-reverse-proxy Endpoint"
  # Required (for now) to trick HAProxy into doing its job; see https://access.redhat.com/solutions/6992561
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Endpoints
      metadata:
        name: fallback-reverse-proxy
        namespace: svc0041p-wordpress
      subsets:
      - addresses:
        # Keep this in sync with whatever the `.spec.externalName` above resolves to.
        - ip: 128.178.222.83
        ports:
        - name: https
          port: 443
          protocol: TCP

- name: "fallback-reverse-proxy Route"
  kubernetes.core.k8s:
    definition:
      kind: Route
      metadata:
        name: fallback-reverse-proxy
        namespace: svc0041p-wordpress
        labels:
          route: public
      spec:
        host: www.epfl.ch
        to:
          kind: Service
          name: fallback-reverse-proxy
        port:
          targetPort: https
        tls:
          termination: reencrypt
          insecureEdgeTerminationPolicy: Redirect
          destinationCACertificate: |
            -----BEGIN CERTIFICATE-----
            MIIDjjCCAnagAwIBAgIQAzrx5qcRqaC7KGSxHQn65TANBgkqhkiG9w0BAQsFADBh
            MQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMRkwFwYDVQQLExB3
            d3cuZGlnaWNlcnQuY29tMSAwHgYDVQQDExdEaWdpQ2VydCBHbG9iYWwgUm9vdCBH
            MjAeFw0xMzA4MDExMjAwMDBaFw0zODAxMTUxMjAwMDBaMGExCzAJBgNVBAYTAlVT
            MRUwEwYDVQQKEwxEaWdpQ2VydCBJbmMxGTAXBgNVBAsTEHd3dy5kaWdpY2VydC5j
            b20xIDAeBgNVBAMTF0RpZ2lDZXJ0IEdsb2JhbCBSb290IEcyMIIBIjANBgkqhkiG
            9w0BAQEFAAOCAQ8AMIIBCgKCAQEAuzfNNNx7a8myaJCtSnX/RrohCgiN9RlUyfuI
            2/Ou8jqJkTx65qsGGmvPrC3oXgkkRLpimn7Wo6h+4FR1IAWsULecYxpsMNzaHxmx
            1x7e/dfgy5SDN67sH0NO3Xss0r0upS/kqbitOtSZpLYl6ZtrAGCSYP9PIUkY92eQ
            q2EGnI/yuum06ZIya7XzV+hdG82MHauVBJVJ8zUtluNJbd134/tJS7SsVQepj5Wz
            tCO7TG1F8PapspUwtP1MVYwnSlcUfIKdzXOS0xZKBgyMUNGPHgm+F6HmIcr9g+UQ
            vIOlCsRnKPZzFBQ9RnbDhxSJITRNrw9FDKZJobq7nMWxM4MphQIDAQABo0IwQDAP
            BgNVHRMBAf8EBTADAQH/MA4GA1UdDwEB/wQEAwIBhjAdBgNVHQ4EFgQUTiJUIBiV
            5uNu5g/6+rkS7QYXjzkwDQYJKoZIhvcNAQELBQADggEBAGBnKJRvDkhj6zHd6mcY
            1Yl9PMWLSn/pvtsrF9+wX3N3KjITOYFnQoQj8kVnNeyIv/iPsGEMNKSuIEyExtv4
            NeF22d+mQrvHRAiGfzZ0JFrabA0UWTW98kndth/Jsw1HKj2ZL7tcu7XUIOGZX1NG
            Fdtom/DzMNU+MeKNhJ7jitralj41E6Vf8PlwUHBHQRFXGU7Aj64GxJUTFy8bJZ91
            8rGOmaFvE7FBcf6IKshPECBV1/MUReXgRPTqh5Uykw7+U0b6LJ3/iyK5S9kJRaTe
            pLiaWN0bfVKfjllDiIGknibVb63dDcY3fe0Dkhvld1927jyNxF1WW6LZZm6zNTfl
            MrY=
            -----END CERTIFICATE-----
