# Ansible playbook for the EPFL WordPress stack

- name: Initial checks
  hosts: all
  gather_facts: no    # Ansible facts are useless for this play
  tasks:
    - name: Check Ansible version
      run_once: true
      assert:
        that: "ansible_version.full is version_compare('2.6', '>=')"
        msg: |
          You must update Ansible to at least 2.6 to use this playbook.

- name: Base System
  hosts: nodes
  gather_facts: False
  roles:
    - name: setup base system requirements
      role: roles/rke2-host
      tags:
        - system

- name: Node configuration
  hosts: nodes
  gather_facts: False
  roles:
    - name: setup rke2 cluster via rke2
      role: roles/rke2-node
      hosts: nodes
      tags:
        - rke2

- name: Cluster configuration
  hosts: clusters
  gather_facts: False
  roles:
    - name: install kinds on rke2 cluster
      role: roles/rke2-cluster
      tags:
        - rke2-cluster

- name: Production reverse-proxy to OpenShift 3 (during rollover period)
  "hosts":
   - namespace|svc0041p-wordpress
  gather_facts: no
  roles:
    - role: roles/openshift-reverse-proxy

- name: WordPress namespaces
  # Like above, members of the all_wordpress_namespaces are OpenShift
  # (or RKE2) namespaces, rather than hosts
  hosts: all_namespaces
  gather_facts: no    # Ansible facts are useless for this play
  vars_files: ansible-k8s-credentials.yml
  environment:
    K8S_AUTH_KUBECONFIG: "{{ k8s_auth_kubeconfig }}"
  roles:
    - role: roles/wordpress-namespace
